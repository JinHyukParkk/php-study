# 3. PHP 지침

## 3.1. 위험과 사용성의 균형
 사용자의 편의성과 보안 수단이 서로 배타적인 것은 아니지만 보안을 강화할수록 사용성을 감소시킵니다. 보안도 중요하지만 정상적인 사용을 염두해야 하기 때문에 그 사이의 적절한 균형점을 찾는 것이 중요합니다. 제한된 정보나 서비스에 접근하기 위해 사용자의 이름 또는 비밀번호를 다시 확인하는 것은 방법 중 하나입니다. 분명 번거롭긴 하지만 공격자에게는 상당한 방해가 될 수 있습니다. 이처럼 사용자에게 보호 수단을 제공하며 사용에 지장이 많이 가지않는 현명한 대처가 필요합니다.

 ## 3.2. 데이터 추적
 보안 의식을 가진 개발자로서 할 수 있는 가장 중요한 것은 항상 데이터를 추적하는 것입니다. 데이터가 출발, 도착하는 곳을 알아야하며 이를 위해서 웹이 어떻게 동작하는지 확실하게 알고 있어야합니다. 하지만 경험이 부족한 개발자는 이를 놓쳐 보안 취얍점을 만들어내는 실수를 범하기 쉽습니다.(내 얘기?)
 예시로 뜬금없이 이메일에서 "RE: Hello" 라는 제목의 스팸에는 쉽게 속지 않을 것입니다. 이유는 내가 먼저 보내지 않은 이상 'RE' 가 올리는 없기 때문입니다. 하지만 여기서 중요한 것은 이메일의 From 헤더를 조작할수 있다는 것입니다. 보면 제목뿐만 아니라 출처까지 무조건적인 신뢰는 잘못 생각하는 것이라 알 수 있습니다. 웹도 마찬가지로 신뢰할 수 있는 데이터와 없는 데이터를 구별해야하며 쉽지는 않습니다. 가장 권장하는 방법은 $_GET, $_POST, $_COOKIE 와 같은 슈퍼 전역배열을 사용하는 것입니다. 이 또한 100%의 신뢰를 보장하기 어렵기 때문에 보약 취약점을 감사할 때는 원격 시스템과 상호 작용하는 코드를 계속해서 중점적으로 살펴보고, 동료의 검토가 많이 필요합니다.

 ## 3.3. 입력 필터링
 필터링은 웹 응용프로그램 보안의 기초입니다. 필터링이란 데이터의 유효성을 증명하는 과정이고 모든 데이터가 필터링이 올바르게 되었다고 확신해야 오염되거나 남용될 위험을 제거할 수 있습니다. 대부분 보안 취약점은 입력을 필터링하지 못한데서 발생합니다.
 - 입력을 구분하는 단계
 - 입력을 필터링하는 단계
 - 필터링된 데이터와 오염된 데이터를 구별하는 단계

 첫번째 단계는 입력을 구분하는 것입니다. 입력된 값을 알지 못하면 필터링하는 것을 확신할 수 없기 때문입니다. 클라이언트가 보내는 어떤 것도 입력이 될 수 있고, 데이터베이스 서버나 RSS 피드 같은 것들도 입력이 될 수 있습니다. 클라이언트가 만들어내는 데이터는 구별하기가 쉬워서 PHP에서는 $_GET과 $_POST와 같은 슈퍼 전역변수로 이 데이터를 이용할 수 있지만 $_SERVER는 클라이언트가 조작할 수 있는 항목들을 상당수 포함하고 있기 때문에 $_SERVER 항목들 중에 어떤 것이 입력이라고 결정하기는 쉽지 않습니다. 그래서 가장 좋은 방법은 이들 전체 배열을 입력이라고 간주하는 것입니다.

 무엇을 입력으로 간주할 것인가는 경우에 따라 다릅니다. 예를 들어 세션 데이터는 서버에 저장되기 때문에 개발자들은 세션 데이터 저장소를 원격 데이터라고 생각하지 않습니다. 이 관점에서 세션 데이터 저장소는 전체 응용 프로그램에 통합된 일부분으로 생각할 수 있고, 세션 데이터 저장소 보안과 응용프로그램 보안이 연결되어 있다는 사실을 항상 염두에 두어야 합니다. 

 두번째 단계는 필터링입니다. 필터링은 인가, 정리, 폐기, 정화와 같은 다양한 동의어들에 대한 다소 형식적인 용어입니다. 하지만 응용프로그램에서는 유효하지 않은 데이터가 입력되는 것을 예방하는 과정을 언급하는 동의어입니다.

  - $clean을 항상 비어있는 배열로 초기화
  - 원격 소스에서 오는 모든 변수를 탐지하고 막을 수 있는 로직 추가

 ###예시)
- 입력 폼
```
<form action="process.php" method="POST">
Please select a color:
<select name="color">
    <option value="red">red</option>
    <option value="green">green</option>
    <option value="blue">blue</option>
</select>
<input type="submit" />
</form>
```
- process.php
```
<?php
$clean = array();
switch($_POST['color]) {
    case 'red':
    case 'green':
    case 'blue':
        $clean['color'] = $_POST['color'];
        break;
}
?>
```
입력이 가능한 데이터 집합을 알고 있는 경우에만 유용한 필터링이지만 사용 가능한 것들로 이뤄진 데이터를 필터링하지 못합니다. 그래서 아래와 같은 경우는 PHP 내부 함수를 이용하여 필터링합니다.
###예시(사용자 ID에 알파벨과 숫자만 가능하게 입력)
```
$clean = array();
if (ctype_alnum($_POST['username'])) {
    $clean['username'] = $_POST['username'];
}
```
정규 표현식 또한 이용할 수 있지만 사용할 수 있는 함수가 존재한다면 함수를 이용하는 것이 바람직합니다. 직접 짜면 오류의 가능성이 있기 때문입니다.

## 3.4. 출력 이스케이프
 웹 응용프로그램의 다른 하나의 기초는 원본 의미를 보전하기 위해 특수문자를 인코딩하거나 출력 이스케이프를 이스케이프하는 원칙을 정하는 것입니다. 예로 MySQL에 작은 따옴표를 보낼 때는 \' 로 표현한다. \는 데이터베이스에 의해 해석되지 않는 데이터의 일부분임을 나타내기 위해 사용한 것입니다. 입력 필터링과 마찬가지로 출력을 이스케이프할 때도 세 가지 단계가 존재한다.
  - 출력을 구분하는 단계
  - 출력을 이스케이프하는 단계
  - 이스케이프된 데이터와 그렇지 않은 데이터를 구분하는 단계
*필터링 후 이스케이프 처리

데이터가 주로 전달되는 곳은 클라이언
